var myepaper;var base64=new Base64();function fileChoose(){var tempPDF=document.srcPDF;init();document.srcPDF=tempPDF;document.getElementById("btn_file").click()};function pdfLoad(){var rf=new FileReader();if(document.getElementById('btn_file').files.length==1){var f=document.getElementById('btn_file').files[0];rf.readAsDataURL(f);rf.onloadend=function(e){if(e.target.readyState==FileReader.DONE){var content=rf.result;fileNameDIV.innerHTML=f.name;document.srcPDF=content.substring(content.indexOf(",")+1);}}}};function changeLocMode(locMode){if(locMode=="byKeyWord"){coorForm.style="display:none";keywordForm.style="margin: 0.5%;width: 100%;height: 74%;display:inherit";}else{keywordForm.style="display:none";coorForm.style="margin: 0.5%;width: 100%;height: 74%;display:inherit";}};function doRealCapture(){var canvas=document.getElementById('picBox');canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);recPic(canvas.toDataURL('image/jpeg').substring(canvas.toDataURL('image/jpeg').indexOf(',')+1));};function doCapture(){var canvas=document.getElementById('picBox');canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);setTimeout(doRealCapture,700);};function bindCapture(){var constraints={audio:false,video:true};var promisifiedOldGUM=function(constraints){var getUserMedia=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia);alert(getUserMedia);if(!getUserMedia){return Promise.reject(new Error('getUserMedia is not implemented in this browser'));}return new Promise(function(resolve,reject){getUserMedia.call(navigator,constraints,resolve,reject);});};if(navigator.mediaDevices===undefined){navigator.mediaDevices={};}if(navigator.mediaDevices.getUserMedia===undefined){navigator.mediaDevices.getUserMedia=promisifiedOldGUM;}var video=document.querySelector('video');var p=navigator.mediaDevices.getUserMedia(constraints);p.then(function(stream){if("srcObject"in video){video.srcObject=stream;}else{video.src=document.URL.createObjectURL(stream);}video.play();video.oncanplay=function(e){if(window.navigator.userAgent.indexOf("Edge")> -1){setTimeout(doCapture,300);}else{setTimeout(doRealCapture,500);}}});p.catch(function(err){alert(err.name+": "+err.message);recPic("noCam");});};function init(){myepaper=new EPaper("signArea");myepaper.setPenSize(3);document.srcPDF="";document.multiData='';document.compoundSealStrategyXml="";downFile.style="display:none";errMsg.style="display:none";video.setAttribute('width',document.getElementById('picBox').getAttribute('width'));video.setAttribute('height',document.getElementById('picBox').getAttribute('height'));};function getData(){var data=myepaper.getHandWritingData();return base64.encodebyte(data);};function clearCanvas(){myepaper.clear();};function getPng(){var pngUrl=myepaper.getHandWritingPng();if(pngUrl!=null)return pngUrl.substring(pngUrl.indexOf(",")+1);else return "noSign";};function recSign(){if(document.getElementById("txtID").value==""||document.getElementById("txtName").value==""){alert("专家信息未填写！");return;}if(document.getElementById("locateOpt").value=="byKeyWord"&&(document.getElementById("keywordtxt").value==""||document.getElementById("keywordX").value==""||document.getElementById("keywordY").value=="")){alert("关键字定位信息未填写！");return;}if(document.getElementById("locateOpt").value=="byCoor"&&(document.getElementById("coorPage").value==""||document.getElementById("coorX").value==""||document.getElementById("coorY").value=="")){alert("坐标定位信息未填写！");return;}if(getPng()=="noSign"){alert("专家尚未签名！");return;}bindCapture();};function recPic(picBase64){var base64=new Base64();var tmpID=document.getElementById("txtID").value;var data=getData();if(document.multiData==''){document.multiData='{"type":"2","fileName":"'+tmpID+'_sign.dat","fileData":"'+data+'"}';}else{document.multiData=document.multiData+',{"type":"2","fileName":"'+tmpID+'_sign.dat","fileData":"'+data+'"}';}if(picBase64!="noCam"){document.multiData=document.multiData+',{"type":"2","fileName":"'+tmpID+'_shot.jpg","fileData":"'+picBase64+'"}';}var proofHashXml='<Proof fileName="'+tmpID+'_shot.jpg'+'" hash="'+sha1(base64.decode(picBase64))+'" type="2" descr=""></Proof>';proofHashXml=proofHashXml+'<Proof fileName="'+tmpID+'_sign.dat'+'" hash="'+sha1(base64.decode(data))+'" type="2" descr=""></Proof>';proofHashXml='<ProofHashXml>'+proofHashXml+'</ProofHashXml>';if(document.getElementById("locateOpt").value=="byCoor"){document.compoundSealStrategyXml=document.compoundSealStrategyXml+"<Request><Type>2</Type>"+"<HandwritingImage>"+getPng()+"</HandwritingImage>"+"<SealPerson>"+document.getElementById("txtName").value+"</SealPerson>"+"<SealLocation>线上</SealLocation><SealReason>评标</SealReason>"+"<IdentificationType>"+document.getElementById("idType").value+"</IdentificationType>"+"<IdentificationNo>"+document.getElementById("txtID").value+"</IdentificationNo>"+"<PhoneNo></PhoneNo><Page>"+document.getElementById("coorPage").value+"</Page>"+"<LX>"+document.getElementById("coorX").value+"</LX>"+"<LY>"+document.getElementById("coorY").value+"</LY>"+proofHashXml+"</Request>";}else{document.compoundSealStrategyXml=document.compoundSealStrategyXml+"<Request><Type>3</Type>"+"<HandwritingImage>"+getPng()+"</HandwritingImage>"+"<SealPerson>"+document.getElementById("txtName").value+"</SealPerson>"+"<SealLocation>线上</SealLocation><SealReason>评标</SealReason>"+"<IdentificationType>"+document.getElementById("idType").value+"</IdentificationType>"+"<IdentificationNo>"+document.getElementById("txtID").value+"</IdentificationNo>"+"<PhoneNo></PhoneNo><Keyword>"+document.getElementById("keywordtxt").value+"</Keyword>"+"<LocationStyle>R</LocationStyle>"+"<LX>"+document.getElementById("keywordX").value+"</LX>"+"<LY>"+document.getElementById("keywordY").value+"</LY>"+proofHashXml+"</Request>";}};function genFile(rep){if(window.navigator.userAgent.indexOf("Safari")> -1&& !(window.navigator.userAgent.indexOf("Chrome")> -1)&& !(window.navigator.userAgent.indexOf("Edge")> -1)&& !(window.navigator.userAgent.indexOf("Firefox")> -1)){var reader=new FileReader();var out=new Blob([rep],{type:'application/pdf'});reader.onload=function(e){var bdata=btoa(reader.result);var datauri='data:application/pdf;base64,'+bdata;downFile.href=datauri;};reader.readAsBinaryString(out);}else{downFile.href=URL.createObjectURL(rep);}downFile.style="";downFile.download=document.outfilename;document.getElementById("progressbar").style="display: none";};function finishBid(){var xhr=new XMLHttpRequest();var base64=new Base64();var date=new Date();var month=date.getMonth()+1;var strDate=date.getDate();if(month>=1&&month<=9){month="0"+month;}if(strDate>=0&&strDate<=9){strDate="0"+strDate;}document.outfilename=date.getFullYear()+month+strDate+"_"+date.getHours()+date.getMinutes()+date.getMinutes()+".pdf";url='https://www.wangyuanhang.com/PaperlessServer/PaperlessServlet';functionType='compoundSealAutoPdf';pdfBeanXml='<PdfBean><Pdf>'+document.srcPDF+'</Pdf><SavedPdfId></SavedPdfId><BizSerialNo></BizSerialNo><BizTypeCode></BizTypeCode><CardNo></CardNo><OutputFilePath>'+'</OutputFilePath><ReturnPdfOrNot>true</ReturnPdfOrNot><Reserved1></Reserved1><Reserved2></Reserved2><Reserved3></Reserved3></PdfBean>';multiData='['+document.multiData+']';if(document.getElementById("locateOpt").value=="byCoor"){compoundSealStrategyXml="<List>"+document.compoundSealStrategyXml+"<Request><Type>2</Type><SealCode>seal001</SealCode><SealPassword>111111</SealPassword>"+"<SealPerson>招投标平台</SealPerson><SealLocation>北京</SealLocation><SealReason>评标确认</SealReason>"+"<BusinessCode></BusinessCode><BusinessCodeStyle></BusinessCodeStyle>"+"<Page>"+document.getElementById("coorPage").value+"</Page><LX>"+document.getElementById("coorX").value+"</LX><LY>"+document.getElementById("coorY").value+"</LY></Request>"+"</List>";}else{compoundSealStrategyXml="<List>"+document.compoundSealStrategyXml+"<Request><Type>3</Type><SealCode>seal001</SealCode><SealPassword>111111</SealPassword>"+"<SealPerson>招投标平台</SealPerson><SealLocation>北京</SealLocation><SealReason>评标确认</SealReason>"+"<BusinessCode></BusinessCode><BusinessCodeStyle></BusinessCodeStyle>"+"<Keyword>"+document.getElementById("keywordtxt").value+"</Keyword><LocationStyle>C</LocationStyle><OffsetX>"+document.getElementById("keywordX").value+"</OffsetX><OffsetY>"+document.getElementById("keywordY").value+"</OffsetY></Request>"+"</List>";}compoundSealStrategyXml=base64.encodestr(compoundSealStrategyXml);operatorCode='gy001';channelBeanXml='PENoYW5uZWw+PENoYW5uZWxDb2RlPnRlc3RDaGFubmVsPC9DaGFubmVsQ29kZT48L0NoYW5uZWw+';xhr.contentType="application/x-www-form-urlencoded; charset=utf-8";xhr.responseType="blob";xhr.open('POST',url,true);xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8");xhr.onload=function(e){};xhr.ontimeout=function(e){alert("无纸化服务器访问超时！");};xhr.onerror=function(e){alert("访问无纸化服务器进行处理失败！");};xhr.upload.onprogress=function(e){var progressBar=document.getElementById("progressbar");if(e.lengthComputable){progressBar.style="width: "+(e.loaded/e.total*50)+"%;display: inherit";}};xhr.onprogress=function(e){var progressBar=document.getElementById("progressbar");if(e.lengthComputable){progressBar.style="width: "+(e.loaded/e.total*30+70)+"%;display: inherit";}};xhr.send('functionType='+functionType+'&systemNo=001&pdfBeanXml='+pdfBeanXml+'&multiData='+multiData+'&compoundSealStrategyXml='+compoundSealStrategyXml+'&operatorCode='+operatorCode+'&channelBeanXml='+channelBeanXml);xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.status==200){var rep=this.response;var rd=new FileReader();rd.readAsText(rep,'utf-8');rd.onload=function(e){if(rd.result.indexOf('Error')> -1){errMsg.style="color:red";errMsg.innerText=rd.result;document.getElementById("progressbar").style="display: none";return;}else{setTimeout(genFile(rep),50);}}}};} 